package com.example.nagoyameshi.service;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import com.example.nagoyameshi.entity.User;
import com.example.nagoyameshi.repository.UserRepository;
import com.stripe.Stripe;
import com.stripe.exception.StripeException;
import com.stripe.model.Subscription;
import com.stripe.param.SubscriptionCancelParams;

import lombok.RequiredArgsConstructor;


@Service
@RequiredArgsConstructor
public class ReviewService {

    @Value("${stripe.api-key}")
    private String stripeApiKey;

    private final UserRepository userRepository; // ← 追加

    public void cancelSubscription(User user) {
        Stripe.apiKey = stripeApiKey;

        try {
            System.out.println("★ 解約処理開始 for user: " + user.getEmail());

            Subscription subscription = Subscription.retrieve(user.getSubscriptionId());
            SubscriptionCancelParams params = SubscriptionCancelParams.builder().build();
            subscription.cancel(params);

            System.out.println("★ Stripe側の解約完了: " + user.getSubscriptionId());

            // ★ DB上の subscriptionId を null にする（もしくは isPremium = false に）
            user.setSubscriptionId(null);  // ← これで再課金防止！
            userRepository.save(user);     // ← DBに反映！

            System.out.println("★ ユーザー情報も更新済み");

        } catch (StripeException e) {
            e.printStackTrace();
        }
    }
}