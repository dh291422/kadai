package com.example.nagoyameshi.controller;

import java.util.Arrays;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;
import java.util.stream.Collectors;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import com.example.nagoyameshi.entity.Restaurant;
import com.example.nagoyameshi.repository.RestaurantRepository;

@Controller
public class HomeController {
    private final RestaurantRepository restaurantRepository;        
    
    public HomeController(RestaurantRepository restaurantRepository) {
        this.restaurantRepository = restaurantRepository;            
    }
    @GetMapping("/")
    public String index(Model model) {
        List<Restaurant> newRestaurants = restaurantRepository.findTop10ByOrderByCreatedAtDesc();
        model.addAttribute("newRestaurants", newRestaurants);
        
        // カテゴリを全部取得
        List<String> rawCategories = restaurantRepository.findAllDistinctCategories();

        // 「居酒屋、焼き肉」などを「居酒屋」「焼き肉」に分割して1つのSetにまとめる
        Set<String> categorySet = rawCategories.stream()
        	    .filter(c -> c != null && !c.isEmpty())
        	    .flatMap(c -> Arrays.stream(c.split("、|,|\\s*，\\s*")))
        	    .map(String::trim)
        	    .filter(s -> !s.isEmpty())
        	    .collect(Collectors.toCollection(TreeSet::new));



        model.addAttribute("categories", categorySet);
    
}