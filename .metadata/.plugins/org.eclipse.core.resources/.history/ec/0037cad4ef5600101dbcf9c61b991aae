package com.example.nagoyameshi.service;

import java.util.UUID;

import jakarta.transaction.Transactional;

import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.stereotype.Service;

import com.example.nagoyameshi.entity.PasswordReset;
import com.example.nagoyameshi.entity.User;
import com.example.nagoyameshi.repository.PasswordResetRepository;

@Service
public class PasswordResetService {

    private final JavaMailSender mailSender;
    private final PasswordResetRepository tokenRepository;

    public PasswordResetService(JavaMailSender mailSender, PasswordResetRepository tokenRepository) {
        this.mailSender = mailSender;
        this.tokenRepository = tokenRepository;
    }

    @Transactional
    public void sendResetEmail(User user, String appUrl) {
        // トークンを生成して保存
        String token = UUID.randomUUID().toString();
        PasswordReset resetToken = new PasswordReset(token, user);
        tokenRepository.save(resetToken);

        // メール送信
        String resetUrl = appUrl + "/password-reset/confirm?token=" + token;

        SimpleMailMessage message = new SimpleMailMessage();
        message.setTo(user.getEmail());
        message.setSubject("【NagoyaMeshi】パスワード再設定のご案内");
        message.setText(
                "以下のリンクをクリックしてパスワードを再設定してください：\n" +
                resetUrl + "\n\n" +
                "※このリンクの有効期限は24時間です。");

        mailSender.send(message);
    }
}
